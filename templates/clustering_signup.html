<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Group Matching Questionnaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/clustering_test.css') }}">
    
    <!-- iOS Safari specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Group Matching">
    
    <!-- Android Chrome specific meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Prevent zoom on input focus (iOS) -->
    <style>
        @media screen and (max-width: 768px) {
            input[type="text"], 
            input[type="email"], 
            input[type="number"], 
            textarea, 
            select {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="questionnaire-container">
                    <div class="header-section text-center mb-4">
                        <h1 class="display-5">üéØ Group Matching</h1>
                        <p class="lead">Answer a few questions to find your perfect group matches!</p>
                        <div class="progress-container">
                            <div class="progress">
                                <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted mt-2 d-block">Question <span id="current-question">1</span> of {{ questions|length + 1 }}</small>
                        </div>
                    </div>

                    <form id="questionnaire-form" novalidate>
                        <!-- Name Section -->
                        <div class="question-card active" data-step="0">
                            <div class="question-header">
                                <h4>üëã Let's start with your name</h4>
                            </div>
                            <div class="form-group">
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="name" 
                                       name="name" 
                                       placeholder="Enter your full name" 
                                       required
                                       autocomplete="name"
                                       autocapitalize="words"
                                       spellcheck="false">
                                <div class="invalid-feedback">
                                    Please enter your name.
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Questions -->
                        {% for question in questions %}
                        {% set outer_loop = loop %}
                        <div class="question-card" data-step="{{ outer_loop.index }}">
                            <div class="question-header">
                                <h4>{{ question.question }}</h4>
                            </div>
                            <div class="choices-container" role="radiogroup" aria-labelledby="question-{{ outer_loop.index0 }}-header">
                                <h5 id="question-{{ outer_loop.index0 }}-header" class="sr-only">{{ question.question }}</h5>
                                {% for choice in question.choices %}
                                <div class="choice-item">
                                    <input type="radio" 
                                           class="form-check-input" 
                                           id="q{{ outer_loop.index0 }}_c{{ loop.index0 }}" 
                                           name="question_{{ outer_loop.index0 }}" 
                                           value="{{ loop.index0 }}" 
                                           required
                                           aria-describedby="q{{ outer_loop.index0 }}_c{{ loop.index0 }}_label">
                                    <label class="choice-label" 
                                           for="q{{ outer_loop.index0 }}_c{{ loop.index0 }}"
                                           id="q{{ outer_loop.index0 }}_c{{ loop.index0 }}_label">
                                        <span class="choice-text">{{ choice }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback d-block" style="display: none !important;" id="question-{{ outer_loop.index0 }}-error">
                                Please select an answer.
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Navigation Buttons -->
                        <div class="navigation-buttons">
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    id="prev-btn" 
                                    style="display: none;"
                                    aria-label="Go to previous question">
                                ‚Üê Previous
                            </button>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    id="next-btn"
                                    aria-label="Go to next question">
                                Next ‚Üí
                            </button>
                            <button type="submit" 
                                    class="btn btn-success" 
                                    id="submit-btn" 
                                    style="display: none;"
                                    aria-label="Submit questionnaire and find matches">
                                üöÄ Find My Matches!
                            </button>
                        </div>
                    </form>

                    <!-- Loading State -->
                    <div class="loading-container" id="loading-state" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>
                            <h4>Processing Your Responses...</h4>
                            <p class="text-muted">Finding your perfect matches!</p>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div class="alert alert-danger" id="error-state" style="display: none;" role="alert">
                        <h5 class="alert-heading">Oops! Something went wrong.</h5>
                        <p id="error-message">Please try again.</p>
                        <button type="button" class="btn btn-outline-danger" onclick="location.reload()">
                            üîÑ Refresh Page
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast for mobile feedback -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">‚úÖ Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Answer saved!
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/clustering_test.js') }}"></script>
    
    <!-- Mobile-specific enhancements -->
    <script>
        // Prevent double-tap zoom on iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Add visual feedback for touch devices
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('choice-label') || e.target.classList.contains('btn')) {
                    e.target.style.opacity = '0.8';
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('choice-label') || e.target.classList.contains('btn')) {
                    setTimeout(() => {
                        e.target.style.opacity = '';
                    }, 150);
                }
            });
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                window.scrollTo(0, 0);
            }, 500);
        });

        // Smooth scrolling for better mobile UX
        document.addEventListener('DOMContentLoaded', function() {
            // Add smooth scrolling behavior
            document.documentElement.style.scrollBehavior = 'smooth';
            
            // Focus management for better accessibility
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        const activeCard = document.querySelector('.question-card.active');
                        if (activeCard) {
                            activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        const activeCard = document.querySelector('.question-card.active');
                        if (activeCard) {
                            activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                });
            }
        });
    </script>
</body>
</html>