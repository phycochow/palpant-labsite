<link rel="stylesheet" href="{{ url_for('static', filename='css/cmportal.css') }}">

{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% block Content %}
    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <div class="tab-link active" data-tab="tab-viewer">Database Viewer</div>
                <div class="tab-link" data-tab="tab-enrichment">Database Enrichment</div>
                <div class="tab-link" data-tab="tab-search">Protocol Search</div>
                <div class="tab-link" data-tab="tab-benchmark">Protocol Benchmarking</div>
            </div>
            
            <!-- Database Viewer -->
            <div id="tab-viewer" class="tab-content active">
                <p>Explore and subset studies based on specific protocol designs and view common variable trends.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="media-type">Media Type</label>
                        <select id="media-type" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI</option>
                            <option value="dmem">DMEM</option>
                            <option value="dmem-fa">DMEM + Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cell-line">Cell Line</label>
                        <select id="cell-line" class="form-control">
                            <option value="">All Cell Lines</option>
                            <option value="bj1">BJ1</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maturation">Maturation Method</label>
                        <select id="maturation" class="form-control">
                            <option value="">All Methods</option>
                            <option value="wnt">Wnt Modulation</option>
                            <option value="stromal">Stromal Cell Inclusion</option>
                            <option value="matrix">Matrix Stiffness</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    UMAP Projection of Protocol Parameters (Fig. 2c)
                </div>
                <div class="well">
                    <div id="table-viewer-container"></div>
                </div>
            </div>
            
            <!-- Database Enrichment -->
            <div id="tab-enrichment" class="tab-content">
                <p>Retrieve outcome-specific features and identify protocol parameters associated with specific endpoints.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="target-outcome">Target Outcome</label>
                        <select id="target-outcome" class="form-control">
                            <option value="contractile">Contractile Force</option>
                            <option value="sarcomere">Sarcomere Length</option>
                            <option value="calcium">Calcium Kinetics</option>
                            <option value="conduction">Conduction Velocity</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Analyze Enrichment</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    Feature Enrichment Visualization (Fig. 2d)
                </div>
                <div class="well">
                    <div id="table-enrichment-container"></div>
                </div>
            </div>
            
            <!-- Protocol Search -->
            <div id="tab-search" class="tab-content">
                <p>Retrieve protocols by application regardless of their intended purpose using outcome-specific features (Fig 2j).</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="application">Target Application</label>
                        <select id="application" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="media-variables">Media Variables</label>
                        <select id="media-variables" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI with B27</option>
                            <option value="dmem-fa">DMEM with Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Find Protocols</button>
                    </div>
                </div>
                <div class="well">
                    <div id="table-search-container"></div>
                </div>
            </div>
            
            <!-- Protocol Benchmarking -->
            <div id="tab-benchmark" class="tab-content">
                <p>Compare your protocol against the compiled dataset using the associated ranges of outcome-enriched protocol features.</p>
                <div class="upload-area mb-3">
                    <p>Drag and drop your protocol file here or click to browse</p>
                    <input type="file" style="display: none;">
                    <button class="btn btn-secondary">Browse Files</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="protocol-purpose">Protocol Purpose</label>
                        <select id="protocol-purpose" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Benchmark Protocol</button>
                    </div>
                </div>
                <div class="visualization">
                    Protocol Benchmarking Visualization
                </div>
                <div class="well">
                    <div id="table-benchmark-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery, Popper.js, Bootstrap JS, and DataTables JS with extensions -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.colVis.min.js"></script>
    
    <script>
    $(document).ready(function() {
        // Tab navigation functionality
        $('.tab-link').click(function(){
            var tab_id = $(this).attr('data-tab');
            
            // Hide all tabs and remove active class
            $('.tab-content').removeClass('active');
            $('.tab-link').removeClass('active');
            
            // Show selected tab and add active class
            $('#' + tab_id).addClass('active');
            $(this).addClass('active');
            
            // Initialize DataTable for the newly displayed tab if not already initialized
            var tableId = tab_id.replace('tab-', '');
            if (!$.fn.dataTable.isDataTable('#table-' + tableId)) {
                initializeDataTable(tableId);
            }
        });
        
        // Make sure the active tab is shown initially
        $('.tab-content').removeClass('active');
        $('#tab-viewer').addClass('active');
        
        // Function to initialize a DataTable with enhanced features
        function initializeDataTable(tableType) {
            var apiEndpoint = '/api/' + tableType;
            
            // Fetch data from the API
            $.getJSON(apiEndpoint, function(data) {
                // Create HTML table structure
                var tableHTML = '<table id="table-' + tableType + '" class="table-compact display" style="width:100%">';
                
                // Create column definitions and headers
                var columns = [];
                if (data.length > 0) {
                    // Extract column headers
                    tableHTML += '<thead><tr>';
                    Object.keys(data[0]).forEach(function(key) {
                        tableHTML += '<th>' + key + '</th>';
                        columns.push({ data: key, title: key });
                    });
                    
                    // Add Actions column if not present
                    if (!Object.keys(data[0]).includes('Actions')) {
                        tableHTML += '<th>Actions</th>';
                        columns.push({ 
                            data: null, 
                            title: 'Actions',
                            defaultContent: '<button class="btn btn-sm btn-link p-0">View</button>',
                            orderable: false
                        });
                    }
                    
                    tableHTML += '</tr></thead>';
                }
                
                // Create table body
                tableHTML += '<tbody></tbody></table>';
                
                // Add table to container
                $('#table-' + tableType + '-container').html(tableHTML);
                
                // Initialize DataTable with enhanced options
                $('#table-' + tableType).DataTable({
                    data: data,
                    columns: columns,
                    scrollX: true,
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    autoWidth: false,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'colvis',
                            className: 'btn btn-primary',
                            text: 'Select Features'
                        },
                        {
                            extend: 'csv',
                            className: 'btn btn-secondary',
                            text: 'Export CSV'
                        }
                    ],
                    language: {
                        search: "_INPUT_",
                        searchPlaceholder: "Search...",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "→",
                            previous: "←"
                        }
                    },
                    columnDefs: [
                        {
                            targets: '_all',
                            className: 'dt-nowrap',
                            render: function(data, type, row) {
                                if (data === null || data === '') {
                                    return 'NaN';
                                }
                                return data;
                            }
                        }
                    ]
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching data from API:', errorThrown);
                $('#table-' + tableType + '-container').html('<div class="alert alert-danger">Error loading data. Please try again later.</div>');
            });
        }
        
        // Alternative TSV data loading for testing/backup
        function loadTSVData(tableType) {
            let tsvURL;
            
            // Set appropriate TSV URL based on table type
            switch(tableType) {
                case 'viewer':
                    tsvURL = 'https://phycochow.github.io/palpantlab_hiPSC_database/datasets/0_Summary_CSYChow_21Aug24.tsv';
                    break;
                // Add cases for other table types as needed
                default:
                    tsvURL = 'https://phycochow.github.io/palpantlab_hiPSC_database/datasets/0_Summary_CSYChow_21Aug24.tsv';
            }
            
            fetch(tsvURL)
                .then(response => response.text())
                .then(tsvText => {
                    const rows = tsvText.split('\n').map(row => 
                        row.split('\t').map(cell => cell === '' ? 'NaN' : cell)
                    );
                    
                    // Extract headers and data
                    const headers = rows[0];
                    const dataRows = rows.slice(1).filter(row => row.length > 1); // Filter out empty rows
                    
                    // Create data objects
                    const data = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || 'NaN';
                        });
                        return obj;
                    });
                    
                    // Create HTML table structure
                    var tableHTML = '<table id="table-' + tableType + '" class="table-compact display" style="width:100%">';
                    
                    // Add headers
                    tableHTML += '<thead><tr>';
                    headers.forEach(header => {
                        tableHTML += '<th>' + header + '</th>';
                    });
                    
                    // Add Actions column
                    tableHTML += '<th>Actions</th>';
                    tableHTML += '</tr></thead><tbody></tbody></table>';
                    
                    // Add table to container
                    $('#table-' + tableType + '-container').html(tableHTML);
                    
                    // Initialize DataTable
                    $('#table-' + tableType).DataTable({
                        data: data,
                        columns: [
                            ...headers.map(header => ({ data: header, title: header })),
                            { 
                                data: null, 
                                title: 'Actions',
                                defaultContent: '<button class="btn btn-sm btn-link p-0">View</button>',
                                orderable: false
                            }
                        ],
                        scrollX: true,
                        pageLength: 10,
                        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                        autoWidth: false,
                        dom: 'Bfrtip',
                        buttons: [
                            {
                                extend: 'colvis',
                                className: 'btn btn-primary',
                                text: 'Select Features'
                            },
                            {
                                extend: 'csv',
                                className: 'btn btn-secondary',
                                text: 'Export CSV'
                            }
                        ],
                        language: {
                            search: "_INPUT_",
                            searchPlaceholder: "Search...",
                            paginate: {
                                first: "First",
                                last: "Last",
                                next: "→",
                                previous: "←"
                            }
                        },
                        columnDefs: [
                            {
                                targets: '_all',
                                className: 'dt-nowrap'
                            }
                        ]
                    });
                })
                .catch(error => {
                    console.error('Error loading TSV:', error);
                    $('#table-' + tableType + '-container').html('<div class="alert alert-danger">Error loading TSV data. Please try again later.</div>');
                });
        }
        
        // Try to initialize the first DataTable with API data
        // If it fails, fall back to TSV loading
        initializeDataTable('viewer');
        
        // Uncomment the line below to use TSV loading instead of API
        // loadTSVData('viewer');
        
        // Handle button click events for DataTable rows
        $(document).on('click', '.btn-link', function() {
            var table = $(this).closest('table').DataTable();
            var data = table.row($(this).parents('tr')).data();
            alert('Viewing details for Protocol: ' + data['Protocol ID']);
            // You can implement a modal or redirect to a detail page here
        });
    });
    </script>
{% endblock %}