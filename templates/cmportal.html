<link rel="stylesheet" href="{{ url_for('static', filename='css/cmportal.css') }}">

{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% block Content %}
    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <div class="tab-link active" data-tab="tab-viewer">Database Viewer</div>
                <div class="tab-link" data-tab="tab-enrichment">Database Enrichment</div>
                <div class="tab-link" data-tab="tab-search">Protocol Search</div>
                <div class="tab-link" data-tab="tab-benchmark">Protocol Benchmarking</div>
            </div>
            
            <!-- Database Viewer -->
            <div id="tab-viewer" class="tab-content active">
                <p>Explore and subset studies based on specific protocol designs and view common variable trends.</p>
                <div class="form-row">
                    {% set viewer_filters = [
                        {'id': 'media-type', 'label': 'Media Type', 'options': [
                            {'value': '', 'text': 'All Media Types'},
                            {'value': 'rpmi', 'text': 'RPMI'},
                            {'value': 'dmem', 'text': 'DMEM'},
                            {'value': 'dmem-fa', 'text': 'DMEM + Fatty Acids'}
                        ]},
                        {'id': 'cell-line', 'label': 'Cell Line', 'options': [
                            {'value': '', 'text': 'All Cell Lines'},
                            {'value': 'bj1', 'text': 'BJ1'},
                            {'value': 'other', 'text': 'Other'}
                        ]},
                        {'id': 'maturation', 'label': 'Maturation Method', 'options': [
                            {'value': '', 'text': 'All Methods'},
                            {'value': 'wnt', 'text': 'Wnt Modulation'},
                            {'value': 'stromal', 'text': 'Stromal Cell Inclusion'},
                            {'value': 'matrix', 'text': 'Matrix Stiffness'}
                        ]}
                    ] %}
                    
                    {% for filter in viewer_filters %}
                        <div class="form-group">
                            <label for="{{ filter.id }}">{{ filter.label }}</label>
                            <select id="{{ filter.id }}" class="form-control">
                                {% for option in filter.options %}
                                    <option value="{{ option.value }}">{{ option.text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endfor %}
                    
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    UMAP Projection of Protocol Parameters (Fig. 2c)
                </div>
                <div class="well">
                    <div id="table-viewer-container"></div>
                </div>
            </div>
            
            <!-- Database Enrichment -->
            <div id="tab-enrichment" class="tab-content">
                <p>Retrieve outcome-specific features and identify protocol parameters associated with specific endpoints.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="target-outcome">Target Outcome</label>
                        <select id="target-outcome" class="form-control">
                            {% set outcome_options = [
                                {'value': 'contractile', 'text': 'Contractile Force'},
                                {'value': 'sarcomere', 'text': 'Sarcomere Length'},
                                {'value': 'calcium', 'text': 'Calcium Kinetics'},
                                {'value': 'conduction', 'text': 'Conduction Velocity'}
                            ] %}
                            
                            {% for option in outcome_options %}
                                <option value="{{ option.value }}">{{ option.text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Analyze Enrichment</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    Feature Enrichment Visualization (Fig. 2d)
                </div>
                <div class="well">
                    <div id="table-enrichment-container"></div>
                </div>
            </div>
            
            <!-- Protocol Search -->
            <div id="tab-search" class="tab-content">
                <p>Retrieve protocols by application regardless of their intended purpose using outcome-specific features (Fig 2j).</p>
                <div class="form-row">
                    {% set search_filters = [
                        {'id': 'application', 'label': 'Target Application', 'options': [
                            {'value': 'ischaemic', 'text': 'Ischaemic Modelling'},
                            {'value': 'disease', 'text': 'Disease Modelling'},
                            {'value': 'drug', 'text': 'Drug Testing'},
                            {'value': 'maturation', 'text': 'Maturation Studies'}
                        ]},
                        {'id': 'media-variables', 'label': 'Media Variables', 'options': [
                            {'value': '', 'text': 'All Media Types'},
                            {'value': 'rpmi', 'text': 'RPMI with B27'},
                            {'value': 'dmem-fa', 'text': 'DMEM with Fatty Acids'}
                        ]}
                    ] %}
                    
                    {% for filter in search_filters %}
                        <div class="form-group">
                            <label for="{{ filter.id }}">{{ filter.label }}</label>
                            <select id="{{ filter.id }}" class="form-control">
                                {% for option in filter.options %}
                                    <option value="{{ option.value }}">{{ option.text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endfor %}
                    
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Find Protocols</button>
                    </div>
                </div>
                <div class="well">
                    <div id="table-search-container"></div>
                </div>
            </div>
            
            <!-- Protocol Benchmarking -->
            <div id="tab-benchmark" class="tab-content">
                <p>Compare your protocol against the compiled dataset using the associated ranges of outcome-enriched protocol features.</p>
                <div class="upload-area mb-3">
                    <p>Drag and drop your protocol file here or click to browse</p>
                    <input type="file" style="display: none;">
                    <button class="btn btn-secondary">Browse Files</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="protocol-purpose">Protocol Purpose</label>
                        <select id="protocol-purpose" class="form-control">
                            {% for option in search_filters[0].options %}
                                <option value="{{ option.value }}">{{ option.text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Benchmark Protocol</button>
                    </div>
                </div>
                <div class="visualization">
                    Protocol Benchmarking Visualization
                </div>
                <div class="well">
                    <div id="table-benchmark-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Required JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.colVis.min.js"></script>
    
    <script>
    $(document).ready(function() {
        // Store API data and table instances
        const state = {
            apiData: null,
            tables: {}
        };
        
        // Configure tab navigation
        $('.tab-link').click(function() {
            const tabId = $(this).attr('data-tab');
            $('.tab-content, .tab-link').removeClass('active');
            $('#' + tabId).addClass('active');
            $(this).addClass('active');
            
            // Load data for the current tab if needed
            if (tabId !== 'tab-benchmark' && !state.tables[tabId]) {
                loadTabData(tabId);
            }
        });
        
        // Initialize first tab
        loadTabData('tab-viewer');
        
        // Load tab data
        function loadTabData(tabId) {
            const containerId = 'table-' + tabId.replace('tab-', '') + '-container';
            const container = $('#' + containerId);
            
            // Show loading indicator
            container.html('<div class="text-center"><p>Loading data...</p><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
            
            // Use cached data or fetch new data
            if (state.apiData) {
                createTable(containerId, state.apiData);
            } else {
                $.getJSON('/api/viewer')
                    .done(function(data) {
                        state.apiData = data;
                        if (!data || data.length === 0) {
                            container.html('<div class="alert alert-info">No data available.</div>');
                            return;
                        }
                        createTable(containerId, data);
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        container.html('<div class="alert alert-danger">Error loading data: ' + errorThrown + '. Please try again later.</div>');
                    });
            }
        }
        
        // Create DataTable
        function createTable(containerId, data) {
            const container = $('#' + containerId);
            const tableId = 'table-' + containerId.replace('table-', '').replace('-container', '');
            const tabId = 'tab-' + containerId.replace('table-', '').replace('-container', '');
            
            // Extract column names
            const columnNames = Object.keys(data[0]).filter(key => key.toLowerCase() !== 'actions');
            
            // Create column definitions
            const columns = columnNames.map(key => ({
                data: key,
                title: key.replace(/_/g, ' ').replace(/\w\S*/g, txt => 
                    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()),
                defaultContent: 'NaN'
            }));
            
            // Create HTML table
            container.html(`<table id="${tableId}" class="table table-striped table-bordered table-compact display" style="width:100%"></table>`);
            
            // Initialize DataTable
            const dataTable = $('#' + tableId).DataTable({
                data: data,
                columns: columns,
                scrollX: true,
                pageLength: 10,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                dom: 'Blfrtip',
                buttons: [
                    {
                        extend: 'colvis',
                        className: 'btn btn-primary btn-sm',
                        text: 'Select Features'
                    },
                    {
                        extend: 'csv',
                        className: 'btn btn-secondary btn-sm',
                        text: 'Export CSV'
                    }
                ],
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search...",
                    emptyTable: "No data available"
                },
                columnDefs: [{
                    targets: '_all',
                    className: 'dt-nowrap',
                    render: (data, type) => 
                        (type === 'display' && (data === null || data === undefined || data === '')) ? 'NaN' : data
                }]
            });
            
            // Store table instance
            state.tables[tabId] = {
                table: dataTable,
                columnMap: createColumnMap(columnNames)
            };
            
            // Set up filters
            setupFilters(tabId);
        }
        
        // Create column map for filtering
        function createColumnMap(columnNames) {
            const map = {};
            columnNames.forEach((name, index) => {
                map[name.toLowerCase()] = index;
            });
            return map;
        }
        
        // Set up tab filters
        function setupFilters(tabId) {
            const tableState = state.tables[tabId];
            if (!tableState) return;
            
            const dataTable = tableState.table;
            const columnMap = tableState.columnMap;
            
            // Define filter mappings for each tab
            const filterMappings = {
                'tab-viewer': {
                    selectors: ['#media-type', '#cell-line', '#maturation'],
                    columns: [
                        ['media_type', 'media', 'mediatype', 'media type'],
                        ['cell_line', 'cellline', 'cell', 'cell type', 'cell line'],
                        ['maturation', 'maturation_method', 'maturation method']
                    ]
                },
                'tab-enrichment': {
                    selectors: ['#target-outcome'],
                    columns: [
                        ['outcome', 'target_outcome', 'target', 'endpoint']
                    ]
                },
                'tab-search': {
                    selectors: ['#application', '#media-variables'],
                    columns: [
                        ['application', 'purpose', 'use_case', 'target_application'],
                        ['media', 'media_type', 'media_variables']
                    ]
                }
            };
            
            // Set up filter handler
            const mapping = filterMappings[tabId];
            if (mapping) {
                $(`#${tabId} .btn-primary`).click(function() {
                    // Clear filters
                    dataTable.search('').columns().search('').draw();
                    
                    // Apply new filters
                    mapping.selectors.forEach((selector, i) => {
                        const value = $(selector).val();
                        if (value) {
                            applyFilter(dataTable, mapping.columns[i], value, columnMap);
                        }
                    });
                    
                    dataTable.draw();
                });
            }
        }
        
        // Apply filter if column exists
        function applyFilter(dataTable, possibleColumns, value, columnMap) {
            for (const colName of possibleColumns) {
                const index = columnMap[colName.toLowerCase()];
                if (index !== undefined) {
                    dataTable.column(index).search(value);
                    return;
                }
            }
        }
    });
    </script>
{% endblock %}