<link rel="stylesheet" href="{{ url_for('static', filename='css/cmportal.css') }}">

{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% block Content %}
    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <div class="tab-link active" data-tab="tab-viewer">Database Viewer</div>
                <div class="tab-link" data-tab="tab-enrichment">Database Enrichment</div>
                <div class="tab-link" data-tab="tab-search">Protocol Search</div>
                <div class="tab-link" data-tab="tab-benchmark">Protocol Benchmarking</div>
            </div>
            
            <!-- Database Viewer -->
            <div id="tab-viewer" class="tab-content active">
                <p>Explore and subset studies based on specific protocol designs and view common variable trends.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="media-type">Media Type</label>
                        <select id="media-type" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI</option>
                            <option value="dmem">DMEM</option>
                            <option value="dmem-fa">DMEM + Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cell-line">Cell Line</label>
                        <select id="cell-line" class="form-control">
                            <option value="">All Cell Lines</option>
                            <option value="bj1">BJ1</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maturation">Maturation Method</label>
                        <select id="maturation" class="form-control">
                            <option value="">All Methods</option>
                            <option value="wnt">Wnt Modulation</option>
                            <option value="stromal">Stromal Cell Inclusion</option>
                            <option value="matrix">Matrix Stiffness</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    UMAP Projection of Protocol Parameters (Fig. 2c)
                </div>
                <div class="well">
                    <div id="table-viewer-container"></div>
                </div>
            </div>
            
            <!-- Database Enrichment -->
            <div id="tab-enrichment" class="tab-content">
                <p>Retrieve outcome-specific features and identify protocol parameters associated with specific endpoints.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="target-outcome">Target Outcome</label>
                        <select id="target-outcome" class="form-control">
                            <option value="contractile">Contractile Force</option>
                            <option value="sarcomere">Sarcomere Length</option>
                            <option value="calcium">Calcium Kinetics</option>
                            <option value="conduction">Conduction Velocity</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Analyze Enrichment</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    Feature Enrichment Visualization (Fig. 2d)
                </div>
                <div class="well">
                    <div id="table-enrichment-container"></div>
                </div>
            </div>
            
            <!-- Protocol Search -->
            <div id="tab-search" class="tab-content">
                <p>Retrieve protocols by application regardless of their intended purpose using outcome-specific features (Fig 2j).</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="application">Target Application</label>
                        <select id="application" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="media-variables">Media Variables</label>
                        <select id="media-variables" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI with B27</option>
                            <option value="dmem-fa">DMEM with Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Find Protocols</button>
                    </div>
                </div>
                <div class="well">
                    <div id="table-search-container"></div>
                </div>
            </div>
            
            <!-- Protocol Benchmarking -->
            <div id="tab-benchmark" class="tab-content">
                <p>Compare your protocol against the compiled dataset using the associated ranges of outcome-enriched protocol features.</p>
                <div class="upload-area mb-3">
                    <p>Drag and drop your protocol file here or click to browse</p>
                    <input type="file" style="display: none;">
                    <button class="btn btn-secondary">Browse Files</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="protocol-purpose">Protocol Purpose</label>
                        <select id="protocol-purpose" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Benchmark Protocol</button>
                    </div>
                </div>
                <div class="visualization">
                    Protocol Benchmarking Visualization
                </div>
                <div class="well">
                    <div id="table-benchmark-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery, Popper.js, Bootstrap JS, and DataTables JS with extensions -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.colVis.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Store API data globally to avoid multiple fetches
            var apiData = null;
            
            // Tab navigation functionality
            $('.tab-link').click(function(){
                var tab_id = $(this).attr('data-tab');
                
                // Hide all tabs and remove active class
                $('.tab-content').removeClass('active');
                $('.tab-link').removeClass('active');
                
                // Show selected tab and add active class
                $('#' + tab_id).addClass('active');
                $(this).addClass('active');
                
                // Only load table data for tabs other than Protocol Benchmarking
                if (tab_id !== 'tab-benchmark') {
                    // Get the container ID for the current tab
                    var containerId = 'table-' + tab_id.replace('tab-', '') + '-container';
                    
                    // Initialize DataTable for the current tab if not already done
                    if (!$.fn.dataTable.isDataTable('#' + containerId + ' table')) {
                        // If we already have the data, use it directly
                        if (apiData) {
                            createTable(containerId, apiData);
                        } else {
                            // Otherwise fetch it first
                            fetchAndCreateTable(containerId);
                        }
                    }
                }
            });
            
            // Make sure the active tab is shown initially
            $('.tab-content').removeClass('active');
            $('#tab-viewer').addClass('active');
            
            // Initialize the first table on page load
            fetchAndCreateTable('table-viewer-container');
            
            // Function to fetch data from API and create table
            function fetchAndCreateTable(containerId) {
                var container = $('#' + containerId);
                
                // Show loading indicator
                container.html('<div class="text-center"><p>Loading data...</p><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
                
                // Fetch data from the API
                $.getJSON('/api/viewer', function(data) {
                    // Store data globally for reuse
                    apiData = data;
                    
                    if (!data || data.length === 0) {
                        container.html('<div class="alert alert-info">No data available.</div>');
                        return;
                    }
                    
                    // Create the table with the data
                    createTable(containerId, data);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching data from API:', errorThrown);
                    container.html('<div class="alert alert-danger">Error loading data: ' + errorThrown + '. Please try again later.</div>');
                });
            }
            
            // Function to create a DataTable in the specified container
            function createTable(containerId, data) {
                var container = $('#' + containerId);
                var tableId = 'table-' + containerId.replace('table-', '').replace('-container', '');
                
                // Get column names dynamically from the first data item, excluding 'actions'
                var columnNames = Object.keys(data[0]).filter(function(key) {
                    return key.toLowerCase() !== 'actions';
                });
                
                // Create HTML table structure
                var tableHTML = '<table id="' + tableId + '" class="table table-striped table-bordered table-compact display" style="width:100%">';
                
                // Create column definitions and headers dynamically
                var columns = [];
                tableHTML += '<thead><tr>';
                columnNames.forEach(function(key) {
                    // Format the column display name (capitalize words, replace underscores with spaces)
                    var displayName = key.replace(/_/g, ' ')
                        .replace(/\w\S*/g, function(txt) {
                            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                        });
                        
                    tableHTML += '<th data-column-name="' + key + '">' + displayName + '</th>';
                    columns.push({ 
                        data: key, 
                        title: displayName,
                        name: key,
                        defaultContent: 'NaN'
                    });
                });
                tableHTML += '</tr></thead>';
                tableHTML += '<tbody></tbody></table>';
                
                // Add table to container
                container.html(tableHTML);
                
                // Initialize DataTable
                var dataTable = $('#' + tableId).DataTable({
                    data: data,
                    columns: columns,
                    scrollX: true,
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    autoWidth: false,
                    dom: 'Blfrtip',
                    buttons: [
                        {
                            extend: 'colvis',
                            className: 'btn btn-primary btn-sm',
                            text: 'Select Features'
                        },
                        {
                            extend: 'csv',
                            className: 'btn btn-secondary btn-sm',
                            text: 'Export CSV'
                        }
                    ],
                    language: {
                        search: "_INPUT_",
                        searchPlaceholder: "Search...",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "→",
                            previous: "←"
                        },
                        emptyTable: "No data available"
                    },
                    columnDefs: [
                        {
                            targets: '_all',
                            className: 'dt-nowrap',
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    return (data === null || data === undefined || data === '') ? 'NaN' : data;
                                }
                                return data;
                            }
                        }
                    ]
                });
                
                // Store column information for filtering
                var columnMap = {};
                columnNames.forEach(function(name, index) {
                    columnMap[name.toLowerCase()] = index;
                });
                
                // Set up tab-specific filter handling
                setupTabFilters(containerId, dataTable, columnMap);
            }
            
            // Setup tab-specific filter handlers
            function setupTabFilters(containerId, dataTable, columnMap) {
                var tabType = containerId.replace('table-', '').replace('-container', '');
                
                if (tabType === 'viewer') {
                    // Handle filter button click in the viewer tab
                    $('#tab-viewer .btn-primary').click(function() {
                        var mediaType = $('#media-type').val();
                        var cellLine = $('#cell-line').val();
                        var maturation = $('#maturation').val();
                        
                        // Clear previous filters
                        dataTable.search('').columns().search('').draw();
                        
                        // Map select element IDs to possible corresponding data column names
                        var filterMap = {
                            'media-type': ['media_type', 'media', 'mediatype', 'media type'],
                            'cell-line': ['cell_line', 'cellline', 'cell', 'cell type', 'cell line'],
                            'maturation': ['maturation', 'maturation_method', 'maturation method']
                        };
                        
                        // Apply filters where columns exist
                        applyFilterIfColumnExists(dataTable, filterMap['media-type'], mediaType, columnMap);
                        applyFilterIfColumnExists(dataTable, filterMap['cell-line'], cellLine, columnMap);
                        applyFilterIfColumnExists(dataTable, filterMap['maturation'], maturation, columnMap);
                        
                        // Redraw table with filters applied
                        dataTable.draw();
                    });
                } 
                else if (tabType === 'enrichment') {
                    // Handle filter button click in the enrichment tab
                    $('#tab-enrichment .btn-primary').click(function() {
                        var targetOutcome = $('#target-outcome').val();
                        
                        // Clear previous filters
                        dataTable.search('').columns().search('').draw();
                        
                        // Map select element IDs to possible corresponding data column names
                        var filterMap = {
                            'target-outcome': ['outcome', 'target_outcome', 'target', 'endpoint']
                        };
                        
                        // Apply filters where columns exist
                        applyFilterIfColumnExists(dataTable, filterMap['target-outcome'], targetOutcome, columnMap);
                        
                        // Redraw table with filters applied
                        dataTable.draw();
                    });
                }
                else if (tabType === 'search') {
                    // Handle filter button click in the search tab
                    $('#tab-search .btn-primary').click(function() {
                        var application = $('#application').val();
                        var mediaVariables = $('#media-variables').val();
                        
                        // Clear previous filters
                        dataTable.search('').columns().search('').draw();
                        
                        // Map select element IDs to possible corresponding data column names
                        var filterMap = {
                            'application': ['application', 'purpose', 'use_case', 'target_application'],
                            'media-variables': ['media', 'media_type', 'media_variables']
                        };
                        
                        // Apply filters where columns exist
                        applyFilterIfColumnExists(dataTable, filterMap['application'], application, columnMap);
                        applyFilterIfColumnExists(dataTable, filterMap['media-variables'], mediaVariables, columnMap);
                        
                        // Redraw table with filters applied
                        dataTable.draw();
                    });
                }
            }
            
            // Function to apply filter if the column exists in the data
            function applyFilterIfColumnExists(dataTable, possibleColumnNames, filterValue, columnMap) {
                if (!filterValue) return; // Skip empty filters
                
                // Check if any of the possible column names exist in our data
                for (var i = 0; i < possibleColumnNames.length; i++) {
                    var columnName = possibleColumnNames[i].toLowerCase();
                    if (columnMap.hasOwnProperty(columnName)) {
                        // Column exists, apply filter
                        dataTable.column(columnMap[columnName]).search(filterValue).draw(false);
                        return; // Exit after applying filter to the first matching column
                    }
                }
                
                // If we get here, no matching column was found
                console.log('Warning: No column found matching any of', possibleColumnNames);
            }
        });
    </script>
{% endblock %}
