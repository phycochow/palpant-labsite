{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% block Content %}
    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <div class="tab-link active" data-tab="tab-viewer">Database Viewer</div>
                <div class="tab-link" data-tab="tab-enrichment">Database Enrichment</div>
                <div class="tab-link" data-tab="tab-search">Protocol Search</div>
                <div class="tab-link" data-tab="tab-benchmark">Protocol Benchmarking</div>
            </div>
            
            <!-- Database Viewer -->
            <div id="tab-viewer" class="tab-content active">
                <p>Explore and subset studies based on specific protocol designs and view common variable trends.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="media-type">Media Type</label>
                        <select id="media-type" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI</option>
                            <option value="dmem">DMEM</option>
                            <option value="dmem-fa">DMEM + Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cell-line">Cell Line</label>
                        <select id="cell-line" class="form-control">
                            <option value="">All Cell Lines</option>
                            <option value="bj1">BJ1</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maturation">Maturation Method</label>
                        <select id="maturation" class="form-control">
                            <option value="">All Methods</option>
                            <option value="wnt">Wnt Modulation</option>
                            <option value="stromal">Stromal Cell Inclusion</option>
                            <option value="matrix">Matrix Stiffness</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    UMAP Projection of Protocol Parameters (Fig. 2c)
                </div>
                <table id="table-viewer" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Protocol ID</th>
                            <th>Media Type</th>
                            <th>Cell Line</th>
                            <th>Maturation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Database Enrichment -->
            <div id="tab-enrichment" class="tab-content" style="display:none;">
                <p>Retrieve outcome-specific features and identify protocol parameters associated with specific endpoints.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="target-outcome">Target Outcome</label>
                        <select id="target-outcome" class="form-control">
                            <option value="contractile">Contractile Force</option>
                            <option value="sarcomere">Sarcomere Length</option>
                            <option value="calcium">Calcium Kinetics</option>
                            <option value="conduction">Conduction Velocity</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Analyze Enrichment</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    Feature Enrichment Visualization (Fig. 2d)
                </div>
                  <table id="table-viewer" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Protocol ID</th>
                            <th>Media Type</th>
                            <th>Cell Line</th>
                            <th>Maturation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Protocol Search -->
            <div id="tab-search" class="tab-content" style="display:none;">
                <p>Retrieve protocols by application regardless of their intended purpose using outcome-specific features (Fig 2j).</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="application">Target Application</label>
                        <select id="application" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="media-variables">Media Variables</label>
                        <select id="media-variables" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI with B27</option>
                            <option value="dmem-fa">DMEM with Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Find Protocols</button>
                    </div>
                </div>
                <table id="table-viewer" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Protocol ID</th>
                            <th>Media Type</th>
                            <th>Cell Line</th>
                            <th>Maturation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Protocol Benchmarking -->
            <div id="tab-benchmark" class="tab-content" style="display:none;">
                <p>Compare your protocol against the compiled dataset using the associated ranges of outcome-enriched protocol features.</p>
                <div class="upload-area mb-3">
                    <p>Drag and drop your protocol file here or click to browse</p>
                    <input type="file" style="display: none;">
                    <button class="btn btn-secondary">Browse Files</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="protocol-purpose">Protocol Purpose</label>
                        <select id="protocol-purpose" class="form-control">
                            <option value="ischaemic">Ischaemic Modelling</option>
                            <option value="disease">Disease Modelling</option>
                            <option value="drug">Drug Testing</option>
                            <option value="maturation">Maturation Studies</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Benchmark Protocol</button>
                    </div>
                </div>
                <div class="visualization">
                    Protocol Benchmarking Visualization
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        document.querySelectorAll('.tab-link').forEach(tabLink => {
            tabLink.addEventListener('click', () => {
                const tabId = tabLink.getAttribute('data-tab');
                
                // Hide all tabs and remove active class
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Show selected tab and add active class
                document.getElementById(tabId).classList.add('active');
                tabLink.classList.add('active');
            });
        });
    </script>
    <!-- jQuery, Popper.js, Bootstrap JS, and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script>
    $(document).ready(function() {
        // Tab navigation functionality
        $('.tab-link').click(function(){
            var tab_id = $(this).attr('data-tab');
            $('.tab-link').removeClass('active');
            $('.tab-content').hide();
            $(this).addClass('active');
            $('#' + tab_id).show();
        });
        
        // Initialize DataTables with AJAX data source for each table.
        $('#table-viewer').DataTable({
            ajax: '/api/viewer',
            columns: [
                { data: 'Protocol ID' },
                { data: 'Media Type' },
                { data: 'Cell Line' },
                { data: 'Maturation' },
                { 
                    data: null,
                    render: function(data, type, row) {
                        return '<a href="#" class="action-btn">View</a> <a href="#" class="action-btn">Export</a>';
                    }
                }
            ]
        });
        
        $('#table-enrichment').DataTable({
            ajax: '/api/enrichment',
            columns: [
                { data: 'Feature' },
                { data: 'Association' },
                { data: 'Significance' },
                { 
                    data: null,
                    render: function(data, type, row) {
                        return '<a href="#" class="action-btn">View Study</a>';
                    }
                }
            ]
        });
        
        $('#table-search').DataTable({
            ajax: '/api/search',
            columns: [
                { data: 'Protocol ID' },
                { data: 'Original Purpose' },
                { data: 'Media Type' },
                { 
                    data: null,
                    render: function(data, type, row) {
                        return '<a href="#" class="action-btn">View Details</a> <a href="#" class="action-btn">Export</a>';
                    }
                }
            ]
        });
    });
    </script>
{% endblock %}
