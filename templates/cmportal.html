{% extends "dashboard.html" %}

{% block Title %}
    CM Portal - Database Modules
{% endblock %}

{% block Logo %}
    <div class="logo">CM<span>Portal</span></div>
{% endblock %}

{% block Sidebar %}
    <nav class="sidebar-menu">
        <a href="#" class="menu-item active">
            <span class="icon icon-database"></span>
            CMPortal
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-enrichment"></span>
            EpiCop
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-search"></span>
            Study 3
        </a>
        <a href="#" class="menu-item">
            <span class="icon icon-benchmark"></span>
            Study 4
        </a>
        <a href="https://palpantlab.duckdns.org/" class="menu-item">
            <span class="icon icon-dashboard"></span>
            Exit Dashboard
        </a>
    </nav>
{% endblock %}

{% block Content %}
    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <div class="tab-link active" data-tab="tab-viewer">Database Viewer</div>
                <div class="tab-link" data-tab="tab-enrichment">Database Enrichment</div>
                <div class="tab-link" data-tab="tab-search">Protocol Search</div>
                <div class="tab-link" data-tab="tab-benchmark">Protocol Benchmarking</div>
            </div>
            
            <!-- Database Viewer -->
            <div id="tab-viewer" class="tab-content active">
                <p>Explore and subset studies based on specific protocol designs and view common variable trends.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="media-type">Media Type</label>
                        <select id="media-type" class="form-control">
                            <option value="">All Media Types</option>
                            <option value="rpmi">RPMI</option>
                            <option value="dmem">DMEM</option>
                            <option value="dmem-fa">DMEM + Fatty Acids</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cell-line">Cell Line</label>
                        <select id="cell-line" class="form-control">
                            <option value="">All Cell Lines</option>
                            <option value="bj1">BJ1</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maturation">Maturation Method</label>
                        <select id="maturation" class="form-control">
                            <option value="">All Methods</option>
                            <option value="wnt">Wnt Modulation</option>
                            <option value="stromal">Stromal Cell Inclusion</option>
                            <option value="matrix">Matrix Stiffness</option>
                        </select>
                    </div>
                    <div class="form-group align-self-end">
                        <button class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="visualization mb-3">
                    UMAP Projection of Protocol Parameters (Fig. 2c)
                </div>
                <table id="table-viewer" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Protocol ID</th>
                            <th>Media Type</th>
                            <th>Cell Line</th>
                            <th>Maturation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Other tabs with minimal content -->
            <div id="tab-enrichment" class="tab-content" style="display:none;">
                <p>Retrieve outcome-specific features and identify protocol parameters associated with specific endpoints.</p>
                <!-- Content hidden for brevity -->
            </div>
            
            <div id="tab-search" class="tab-content" style="display:none;">
                <p>Retrieve protocols by application regardless of their intended purpose using outcome-specific features.</p>
                <!-- Content hidden for brevity -->
            </div>
            
            <div id="tab-benchmark" class="tab-content" style="display:none;">
                <p>Compare your protocol against the compiled dataset using the associated ranges of outcome-enriched protocol features.</p>
                <!-- Content hidden for brevity -->
            </div>
        </div>
    </div>

    <!-- jQuery, Popper.js, Bootstrap JS, and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script>
    $(document).ready(function() {
        // Tab navigation functionality
        $('.tab-link').click(function(){
            var tab_id = $(this).attr('data-tab');
            $('.tab-link').removeClass('active');
            $('.tab-content').hide();
            $(this).addClass('active');
            $('#' + tab_id).show();
        });
        
        // Ensure active tab is shown initially
        $('.tab-content').hide();
        $('.tab-content.active').show();
        
        // Debug: Check if API is returning data
        $.getJSON('/api/viewer', function(data) {
            console.log('API data:', data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('API error:', textStatus, errorThrown);
        });
        
        // Initialize DataTable with proper data format
        $('#table-viewer').DataTable({
            ajax: {
                url: '/api/viewer',
                dataSrc: '' // This tells DataTables the data is an array
            },
            columns: [
                { data: 'Protocol ID' },
                { data: 'Media Type' },
                { data: 'Cell Line' },
                { data: 'Maturation' },
                { 
                    data: null,
                    defaultContent: '<a href="#" class="action-btn">View</a> <a href="#" class="action-btn">Export</a>'
                }
            ]
        });
    });
    </script>
{% endblock %}